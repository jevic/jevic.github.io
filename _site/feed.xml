<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.7.3">Jekyll</generator><link href="http://0.0.0.0/feed.xml" rel="self" type="application/atom+xml" /><link href="http://0.0.0.0/" rel="alternate" type="text/html" /><updated>2018-06-08T00:32:57+08:00</updated><id>http://0.0.0.0/</id><title type="html">Jevic</title><subtitle>前路漫漫,忆往昔......</subtitle><author><name>Jevic</name></author><entry><title type="html">kafka 数据保存时间动态调整</title><link href="http://0.0.0.0/2018/06/07/kafka-data-clear/" rel="alternate" type="text/html" title="kafka 数据保存时间动态调整" /><published>2018-06-07T22:07:44+08:00</published><updated>2018-06-07T22:07:44+08:00</updated><id>http://0.0.0.0/2018/06/07/kafka-data-clear</id><content type="html" xml:base="http://0.0.0.0/2018/06/07/kafka-data-clear/">&lt;blockquote&gt;
  &lt;p&gt;动态调整kafka 数据保存时间&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;## kafka 版本: kafka_2.10-0.8.2.2&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;topics&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;test1 test2&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;zk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;zk1:2181,zk2:2181,zk3:2181/kafka&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;### 修改保留时间&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;### 保留几个小时&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;hours&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2
&lt;span class=&quot;c&quot;&gt;### 转换为毫秒&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Times&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hours&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; * 3600000&quot;&lt;/span&gt;|bc&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;## 修改配置&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;### 控制未压缩数据 retention.ms&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;conf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;retention.ms&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;### 控制压缩后的数据 delete.retention.ms&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#conf=&quot;delete.retention.ms&quot;&lt;/span&gt;

ClearLog&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;## 清理数据&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;i &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$topics&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;do
&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/opt/kafka/bin/kafka-topics.sh --zookeeper &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$zk&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; --alter --topic &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$i&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; --config &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;conf&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Times&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#/opt/kafka/bin/kafka-topics.sh --zookeeper $zk --alter --topic $i --config ${conf}=${Times}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

DelConf&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;## 删除配置&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/opt/kafka/bin/kafka-topics.sh --zookeeper &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$zk&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; --alter --topic &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$i&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; --delete-config &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$conf&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#/opt/kafka/bin/kafka-topics.sh --zookeeper $zk --alter --topic $i --delete-config $conf&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in
     &lt;/span&gt;clear&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
     ClearLog &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;
     delconf&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
     DelConf &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;
     &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
     &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;clear --- 清理日志&quot;&lt;/span&gt;
     &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;delconf --- 删除配置&quot;&lt;/span&gt;
     &lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;esac&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;转载请注明出处，本文采用 &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; 协议授权&lt;/p&gt;</content><author><name>Jevic</name></author><summary type="html">动态调整kafka 数据保存时间</summary></entry><entry><title type="html">Rancher 部署Traefik 实现微服务快速发现</title><link href="http://0.0.0.0/2018/02/28/traefik-rancher/" rel="alternate" type="text/html" title="Rancher 部署Traefik 实现微服务快速发现" /><published>2018-02-28T21:12:36+08:00</published><updated>2018-02-28T21:12:36+08:00</updated><id>http://0.0.0.0/2018/02/28/traefik-rancher</id><content type="html" xml:base="http://0.0.0.0/2018/02/28/traefik-rancher/">&lt;blockquote&gt;
  &lt;p&gt;Traefik是一个为了让部署微服务更加便捷而诞生的现代HTTP反向代理、负载均衡工具。本文将向你展示如何在Rancher上简单快速地部署Traefik，实现微服务的快速发现&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;https://docs.traefik.io/img/traefik.logo.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;traefik-是什么&quot;&gt;Traefik 是什么?&lt;/h2&gt;
&lt;p&gt;Traefik 是一个为了让部署微服务更加便捷而诞生的现代HTTP反向代理、负载均衡工具。它支持多种后台 (Rancher、Docker、Swarm、Kubernetes、Marathon、Mesos、Consul、Etcd、Zookeeper、BoltDB、Rest API、file…) 来自动、动态的刷新配置文件，以实现快速地服务发现
&lt;img src=&quot;https://docs.traefik.io/img/architecture.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;特性&quot;&gt;特性&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;它非常快&lt;/li&gt;
  &lt;li&gt;无需安装其他依赖，通过Go语言编写的单一可执行文件&lt;/li&gt;
  &lt;li&gt;支持 Rest API&lt;/li&gt;
  &lt;li&gt;多种后台支持：Rancher、Docker、Swarm、Kubernetes、Marathon、Mesos、Consul、Etcd，并且还会更多&lt;/li&gt;
  &lt;li&gt;后台监控，可以监听后台变化进而自动化应用新的配置文件设置&lt;/li&gt;
  &lt;li&gt;配置文件热更新。无需重启进程&lt;/li&gt;
  &lt;li&gt;正常结束http连接&lt;/li&gt;
  &lt;li&gt;后端断路器&lt;/li&gt;
  &lt;li&gt;轮询，rebalancer 负载均衡&lt;/li&gt;
  &lt;li&gt;Rest Metrics&lt;/li&gt;
  &lt;li&gt;支持最小化 官方 docker 镜像&lt;/li&gt;
  &lt;li&gt;后台支持SSL&lt;/li&gt;
  &lt;li&gt;前台支持SSL（包括SNI）&lt;/li&gt;
  &lt;li&gt;清爽的AngularJS前端页面&lt;/li&gt;
  &lt;li&gt;支持Websocket&lt;/li&gt;
  &lt;li&gt;支持HTTP/2&lt;/li&gt;
  &lt;li&gt;网络错误重试&lt;/li&gt;
  &lt;li&gt;支持Let’s Encrypt (自动更新HTTPS证书)&lt;/li&gt;
  &lt;li&gt;高可用集群模式&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;清爽的界面&quot;&gt;清爽的界面&lt;/h2&gt;
&lt;p&gt;Traefik 拥有一个基于AngularJS编写的简单网站界面。
&lt;img src=&quot;http://traefik.cn/frontend/images/web.frontend.png&quot; alt=&quot;&quot; /&gt;
&lt;img src=&quot;http://traefik.cn/frontend/images/traefik-health.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;rancher-traefik-部署&quot;&gt;Rancher-Traefik 部署&lt;/h2&gt;
&lt;h3 id=&quot;添加节点主机标签&quot;&gt;添加节点主机标签&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-01-02.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
&lt;h3 id=&quot;安装-traefik-应用&quot;&gt;安装 Traefik 应用&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;点击查看详情进入配置界面, http port 端口改为80,其他配置保持默认&lt;/li&gt;
  &lt;li&gt;最后点击启动；
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-02.png&quot; alt=&quot;&quot; /&gt;
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-03.png&quot; alt=&quot;&quot; /&gt;
    &lt;h4 id=&quot;修改rancher-默认traefikdomain&quot;&gt;修改rancher 默认traefik.domain&lt;/h4&gt;
    &lt;blockquote&gt;
      &lt;p&gt;由于rancher提供的镜像默认traefik.domain 为: rancher.internal,需要修改为自己所使用的方可
如果服务指定了 traefik.frontend.rule = Host:xxxx.com 标签,则会使用自定义前端域名访问
建议直接指定访问域名&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;方式一：
    &lt;ul&gt;
      &lt;li&gt;升级服务 加入环境变量: TRAEFIK_RANCHER_DOMAIN = jevic.cn
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-20.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;方式二:
    &lt;ul&gt;
      &lt;li&gt;直接基于社区Dockerfile 修改域名&lt;/li&gt;
      &lt;li&gt;https://github.com/rawmind0/alpine-traefik.git&lt;/li&gt;
      &lt;li&gt;路径: alpine-traefik/root/opt/traefik/bin/traefik.toml.sh
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-21.png&quot; alt=&quot;&quot; /&gt;
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-22.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;进入 应用|用户 视图,查看应用；
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-04.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
  &lt;li&gt;此时可以访问 Traefik_host:8000 管理后台&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;运行-demo-示例&quot;&gt;运行 demo 示例&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;新建一个名为 demo 的空应用栈；&lt;/li&gt;
  &lt;li&gt;在 demo 中添加一个名为 nginx 的服务&lt;/li&gt;
  &lt;li&gt;Traefik默认强制开启健康检查，所有只有健康的服务才会被注册到Traefik上。在健康检查中配置健康检查
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-05.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;标签设定&quot;&gt;标签设定&lt;/h4&gt;
&lt;h5 id=&quot;默认标签设置&quot;&gt;默认标签设置&lt;/h5&gt;
&lt;ul&gt;
  &lt;li&gt;traefik.enable = true 可以理解为是否把此服务注册到traefik的一个开关;
    &lt;ul&gt;
      &lt;li&gt;true: the service will be published as service_name.stack_name.traefik_domain&lt;/li&gt;
      &lt;li&gt;stack: the service will be published as stack_name.traefik_domain. WARNING: You could have collisions inside services within your stack&lt;/li&gt;
      &lt;li&gt;false: the service will not be published&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;traefik.domain = jevic.cn 一个适用于所有服务访问的主域名，可以设置多个用逗号隔开;&lt;/li&gt;
  &lt;li&gt;traefik.alias = nginx 服务别名，可以理解为主域名下的二级域名，可以设置多个用逗号隔开；&lt;/li&gt;
  &lt;li&gt;traefik.port = 80 告诉traefik 服务暴露的端口号；&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-06.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;此时 Traefik管理后台 显示的前端访问域名为:&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;http://&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;service_name&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;stack_name&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;traefik&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.domain&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;:&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;http_port&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
https://&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;service_name&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;stack_name&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;traefik&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.domain&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;:&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;https_port&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-07.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h5 id=&quot;自定义前端host-建议使用此方式&quot;&gt;自定义前端Host [建议使用此方式]&lt;/h5&gt;
&lt;ul&gt;
  &lt;li&gt;traefik.frontend.rule = Host:ops.jevic.cn 直接定义前端访问域名,多个使用’,’分割&lt;/li&gt;
  &lt;li&gt;traefik.port = 80&lt;/li&gt;
  &lt;li&gt;traefik.enable = true&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-06-2.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;前端访问域名:
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-07-02.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;最终应用栈如下所示&quot;&gt;最终,应用栈如下所示&lt;/h4&gt;
&lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-11.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;访问测试&quot;&gt;访问测试&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;如上面图示，控制台显示了当前前端访问host 域名以及后端的节点状态&lt;/li&gt;
  &lt;li&gt;测试域名访问:
    &lt;ul&gt;
      &lt;li&gt;app.jevic.cn&lt;/li&gt;
      &lt;li&gt;ops.jevic.cn&lt;/li&gt;
      &lt;li&gt;nginx.demo.jevic.cn
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-13.png&quot; alt=&quot;&quot; /&gt;
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-12.png&quot; alt=&quot;&quot; /&gt;
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-09.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;http://192.168.3.27:8000/dashboard/#/health
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/traefik-demo-10.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;参考链接&quot;&gt;参考链接&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/rawmind0/alpine-traefik/tree/master/rancher&quot;&gt;alpine-traefik&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.traefik.io/&quot;&gt;Traefik.io&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.traefik.cn/&quot;&gt;traefik.cn&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;转载请注明出处，本文采用 &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; 协议授权&lt;/p&gt;</content><author><name>Jevic</name></author><summary type="html">Traefik是一个为了让部署微服务更加便捷而诞生的现代HTTP反向代理、负载均衡工具。本文将向你展示如何在Rancher上简单快速地部署Traefik，实现微服务的快速发现</summary></entry><entry><title type="html">gitlab CI/CD 自动化构建Rancher容器服务</title><link href="http://0.0.0.0/2018/02/06/gitlab-cicd-rancher-build/" rel="alternate" type="text/html" title="gitlab CI/CD 自动化构建Rancher容器服务" /><published>2018-02-06T19:07:22+08:00</published><updated>2018-02-06T19:07:22+08:00</updated><id>http://0.0.0.0/2018/02/06/gitlab-cicd-rancher-build</id><content type="html" xml:base="http://0.0.0.0/2018/02/06/gitlab-cicd-rancher-build/">&lt;h1 id=&quot;概述&quot;&gt;概述&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;gitlab&lt;/li&gt;
  &lt;li&gt;rancher&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;rancher&quot;&gt;Rancher&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://www.cnrancher.com/&quot;&gt;Rancher&lt;/a&gt;是一个开源的企业级容器管理平台。通过Rancher，企业再也不必自己使用一系列的开源软件去从头搭建容器服务平台。Rancher提供了在生产环境中使用的管理Docker和Kubernetes的全栈化容器部署与管理平台。
&lt;img src=&quot;http://rancher.com/docs/img/rancher/rancher_overview_2.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
&lt;h2 id=&quot;gitlab-cicd&quot;&gt;Gitlab CI/CD&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;https://docs.gitlab.com/ee/ci/img/cicd_pipeline_infograph.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
&lt;h3 id=&quot;1-gitlab&quot;&gt;1. Gitlab&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.gitlab.com/ee/README.html&quot;&gt;GitLab&lt;/a&gt; 是一个利用Ruby on Rails开发的开源应用程序，实现一个自托管的Git项目仓库，可通过Web界面进行访问公开的或者私人项目。
它拥有与GitHub类似的功能，能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。团队成员可以利用内置的简单聊天程序（Wall）进行交流。它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后有需要的时候进行查找。&lt;/p&gt;

&lt;h3 id=&quot;2-gitlab-ci&quot;&gt;2. Gitlab-CI&lt;/h3&gt;
&lt;p&gt;Gitlab-CI是GitLab Continuous Integration（Gitlab持续集成）的简称。
从Gitlab的8.0版本开始，gitlab就全面集成了Gitlab-CI,并且对所有项目默认开启。
只要在项目仓库的根目录添加.gitlab-ci.yml文件，并且配置了Runner（运行器），那么每一次合并请求（MR）或者push都会触发CI pipeline。&lt;/p&gt;

&lt;h3 id=&quot;3-gitlab-runner&quot;&gt;3. Gitlab-runner&lt;/h3&gt;
&lt;p&gt;Gitlab-runner 是.gitlab-ci.yml脚本的运行器，Gitlab-runner是基于Gitlab-CI的API进行构建的相互隔离的机器（或虚拟机）。GitLab Runner 不需要和Gitlab安装在同一台机器上，但是考虑到GitLab Runner的资源消耗问题和安全问题，也不建议这两者安装在同一台机器上。&lt;/p&gt;

&lt;p&gt;Gitlab Runner分为两种，Shared runners和Specific runners。
Specific runners只能被指定的项目使用，Shared runners则可以运行所有开启 Allow shared runners选项的项目。&lt;/p&gt;

&lt;h3 id=&quot;4-pipelines&quot;&gt;4. Pipelines&lt;/h3&gt;
&lt;p&gt;Pipelines是定义于.gitlab-ci.yml中的不同阶段的不同任务。
我把Pipelines理解为流水线，流水线包含有多个阶段（stages），每个阶段包含有一个或多个工序（jobs），比如先购料、组装、测试、包装再上线销售，每一次push或者MR都要经过流水线之后才可以合格出厂。而.gitlab-ci.yml正是定义了这条流水线有哪些阶段，每个阶段要做什么事。&lt;/p&gt;

&lt;h3 id=&quot;5-badges&quot;&gt;5. Badges&lt;/h3&gt;
&lt;p&gt;徽章，当Pipelines执行完成，会生成徽章，你可以将这些徽章加入到你的README.md文件或者你的网站。&lt;/p&gt;

&lt;h2 id=&quot;环境配置&quot;&gt;环境配置&lt;/h2&gt;
&lt;h3 id=&quot;rancher-1&quot;&gt;Rancher&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;具体安装请查看&lt;a href=&quot;http://rancher.com/docs/rancher/v1.6/zh/&quot;&gt;官网文档&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h4 id=&quot;运行-nginx-服务&quot;&gt;运行 Nginx 服务&lt;/h4&gt;
&lt;h5 id=&quot;1-添加私有仓库并添加证书&quot;&gt;1. 添加私有仓库并添加证书&lt;/h5&gt;
&lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-registry.jpg&quot; alt=&quot;&quot; /&gt;
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-registry-02.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
&lt;h5 id=&quot;2-创建应用服务&quot;&gt;2. 创建应用服务&lt;/h5&gt;
&lt;ul&gt;
  &lt;li&gt;网络模式: &lt;code class=&quot;highlighter-rouge&quot;&gt;主机&lt;/code&gt;，如果设置为manage 需要配置&lt;code class=&quot;highlighter-rouge&quot;&gt;负载均衡&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;切记要对服务进行标签设定
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-nginx-01.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;访问
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-web-01.jpg&quot; alt=&quot;&quot; /&gt;
    &lt;h5 id=&quot;3-添加接收器-webhooks&quot;&gt;3. 添加接收器 webhooks&lt;/h5&gt;
    &lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-webhook.jpg&quot; alt=&quot;&quot; /&gt;
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-webhook-02.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;gitlab&quot;&gt;Gitlab&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;中文社区版 &lt;a href=&quot;https://hub.docker.com/r/twang2218/gitlab-ce-zh/&quot;&gt;docker hub&lt;/a&gt;
安装步骤省略…..&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;gitlab-runner&quot;&gt;gitlab-runner&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;注: 主版本要与gitlab 一致否则无法添加!!!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;a href=&quot;https://gitlab.com/gitlab-org/gitlab-runner/blob/master/docs/configuration/advanced-configuration.md&quot;&gt;高级配置&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;官方镜像并未配置docker CLI,如有需要安装即可，否则直接使用官方镜像run 即可。&lt;/li&gt;
  &lt;li&gt;此处基于官方镜像配置docker CLI，并运行&lt;/li&gt;
&lt;/ul&gt;

&lt;h5 id=&quot;安装docker-命令&quot;&gt;安装docker 命令&lt;/h5&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# cat Dockerfile&lt;/span&gt;
FROM gitlab/gitlab-runner:v9.2.2
RUN curl &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; https://get.docker.com/builds/Linux/x86_64/docker-latest.tgz  &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;tar &lt;/span&gt;zxvf docker-latest.tgz &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; cp docker/docker /usr/local/bin/ &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm &lt;span class=&quot;nt&quot;&gt;-rf&lt;/span&gt; docker docker-latest.tgz  
&lt;span class=&quot;c&quot;&gt;# docker build -t gitlab-runner:docker .&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;运行&quot;&gt;运行&lt;/h5&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; gitlab-runner &lt;span class=&quot;nt&quot;&gt;--restart&lt;/span&gt; always &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; /srv/gitlab-runner/config:/etc/gitlab-runner &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; /var/run/docker.sock:/var/run/docker.sock &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
gitlab-runner:docker

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;配置sudo&quot;&gt;配置sudo&lt;/h5&gt;
&lt;blockquote&gt;
  &lt;p&gt;由于需要执行docker 命令所以需要配置sudo 免密码执行权限&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# docker exec -it 0c115c075b32 /bin/bash&lt;/span&gt;
root@0c115c075b32:/# &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /etc/sudoers |grep gitlab
gitlab-runner    &lt;span class=&quot;nv&quot;&gt;ALL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=(&lt;/span&gt;ALL&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;       NOPASSWD: ALL

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;注册-runners&quot;&gt;注册 Runners&lt;/h5&gt;
&lt;blockquote&gt;
  &lt;p&gt;根据提示输入指定参数即可&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;URL  gitlab URL&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;token 注册认证token&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;description 描述信息，自定义&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;tags  用来区分多个runners,自定义&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;executor 根据需要选择即可，此处选择的shell&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-runners.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;register&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@0c115c075b32:/# gitlab-ci-multi-runner register
Running &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;system-mode.

Please enter the gitlab-ci coordinator URL &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;e.g. https://gitlab.com/&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
http://test.gitlab.com/ci
Please enter the gitlab-ci token &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;this runner:
xxxxxxxx-xxxxxxx
Please enter the gitlab-ci description &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;this runner:
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0c115c075b32]: t197
Please enter the gitlab-ci tags &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;this runner &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;comma separated&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
t197
Whether to run untagged builds &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;/false]:
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;: 直接回车
Whether to lock Runner to current project &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;/false]:
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;: 直接回车
INFO[0034] fcf5c619 Registering runner... succeeded
Please enter the executor: shell, docker, docker-ssh, ssh?
shell
INFO[0037] Runner registered successfully. Feel free to start it, but &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;it&lt;span class=&quot;s1&quot;&gt;'s
running already the config should be automatically reloaded!
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;此时打开gitlab CI/CD 设置页面 即可查看到注册的Runners
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-set-01.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;设置构建时的环境变量
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-set-02.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h5 id=&quot;至此所有准备工作完毕下面开始首次构建&quot;&gt;至此所有准备工作完毕，下面开始首次构建&lt;/h5&gt;
&lt;h3 id=&quot;cicd-test&quot;&gt;CI/CD Test&lt;/h3&gt;
&lt;h4 id=&quot;dockerfile-version01&quot;&gt;dockerfile Version0.1&lt;/h4&gt;
&lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-web-01.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;下面将通过gitlab ci/cd 结合rancher 升级服务到version 0.2&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h4 id=&quot;update-version02&quot;&gt;update Version0.2&lt;/h4&gt;
&lt;blockquote&gt;
  &lt;p&gt;编辑更新Dockerfile&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;FROM nginx:alpine

RUN &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&amp;lt;h2&amp;gt;Gitlab CI/CD on Rancher NginxApp Version 0.2....&amp;lt;h2&amp;gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /usr/share/nginx/html/index.html

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h4 id=&quot;rancher-服务升级触发脚本&quot;&gt;Rancher 服务升级触发脚本&lt;/h4&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;## rancher 触发器&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Webhook&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;## 仓库名称&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;repo&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$2&lt;/span&gt;

curl &lt;span class=&quot;nt&quot;&gt;-XPOST&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-H&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'content-type: application/json'&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$Webhook&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{
    &quot;push_data&quot;: {
        &quot;tag&quot;: &quot;master&quot;
    },
    &quot;repository&quot;: {
        &quot;repo_name&quot;: &quot;'&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$repo&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'&quot;
    }
}'&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;gitlab-ciyml&quot;&gt;.gitlab-ci.yml&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.gitlab.com/ce/ci/yaml/README.html&quot;&gt;官方配置文件详解&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/wmq880204/article/details/70141771&quot;&gt;中文说明&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;引用Runners 添加的环境变量&lt;/li&gt;
  &lt;li&gt;尽量使用环境变量来引用各个参数&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;jay➜/tmp/cicd&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master✗&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;» &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; .gitlab-ci.yml                                                                                                                             &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;16:19:16]
variables:
  Tags: master

stages:
  - build
  - release
&lt;span class=&quot;c&quot;&gt;# 环境&lt;/span&gt;
before_script:
  - &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;docker &lt;span class=&quot;nt&quot;&gt;--version&lt;/span&gt;
  - &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;uname &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 构建镜像&lt;/span&gt;
build:
  stage: build
  script:
    - &lt;span class=&quot;nb&quot;&gt;sudo echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$repo&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$Tags&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
    - &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;docker build &lt;span class=&quot;nt&quot;&gt;--pull&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$repo&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$Tags&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
    - &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;docker login &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$USER&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$PASSWD&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$registry&lt;/span&gt;
    - &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;docker push &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$repo&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$Tags&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
    - &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;docker rmi &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$repo&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$Tags&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 升级rancher服务&lt;/span&gt;
release:
  stage: release
  script:
    - sh update.sh &lt;span class=&quot;nv&quot;&gt;$Webhook&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$repo&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;提交commit&quot;&gt;提交commit&lt;/h4&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;jay➜/tmp/cicd&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master✗&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;» git add &lt;span class=&quot;nt&quot;&gt;--all&lt;/span&gt;                                                                                                                                  &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;16:28:37]

jay➜/tmp/cicd&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master✗&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;» git commit &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;version 0.2&quot;&lt;/span&gt;                                                                                                                    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;16:29:25]
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;master 6647463] version 0.2
 2 files changed, 4 insertions&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;+&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, 3 deletions&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;-&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

jay➜/tmp/cicd&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;» git push origin master                                                                                                                          &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;16:30:20]
Counting objects: 4, &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Delta compression using up to 4 threads.
Compressing objects: 100% &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;4/4&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Writing objects: 100% &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;4/4&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, 412 bytes | 0 bytes/s, &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
Total 4 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;delta 3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, reused 0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;delta 0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
To http://test.gitlab.com/jevic/cicd.git
   3dd8d23..6647463  master -&amp;gt; master
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;查看项目状态&quot;&gt;查看项目状态&lt;/h4&gt;
&lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-ok.jpg&quot; alt=&quot;&quot; /&gt;
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-02.jpg&quot; alt=&quot;&quot; /&gt;
&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-03.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;页面访问&quot;&gt;页面访问&lt;/h4&gt;
&lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/rancher-gitlab-cicd-web-02.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;转载请注明出处，本文采用 &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; 协议授权&lt;/p&gt;</content><author><name>Jevic</name></author><summary type="html">概述 gitlab rancher</summary></entry><entry><title type="html">etcd-confd 配置管理</title><link href="http://0.0.0.0/2018/01/31/confd-etcd/" rel="alternate" type="text/html" title="etcd-confd 配置管理" /><published>2018-01-31T14:40:58+08:00</published><updated>2018-01-31T14:40:58+08:00</updated><id>http://0.0.0.0/2018/01/31/confd-etcd</id><content type="html" xml:base="http://0.0.0.0/2018/01/31/confd-etcd/">&lt;h1 id=&quot;confd&quot;&gt;confd&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/kelseyhightower/confd/releases&quot;&gt;下载&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;解压放到 /usr/local/bin 即可&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;demo&quot;&gt;demo&lt;/h2&gt;
&lt;h3 id=&quot;创建目录&quot;&gt;创建目录&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mkdir /etc/confd/&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;conf.d,templates&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;配置文件&quot;&gt;配置文件&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master confd]# &lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;conf.d/jevic-cn.toml
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;template]
src &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;jevic-conf.tmpl&quot;&lt;/span&gt;
dest &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/tmp/jevic.conf&quot;&lt;/span&gt;
keys &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;/config/myapp/jevic/database/upstream&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;/config/myapp/jevic/database/hosts&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;/config/myapp/jevic/database/domain&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;模板&quot;&gt;模板&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/etcd-confd-templates.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;生成配置&quot;&gt;生成配置&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master ~]# confd &lt;span class=&quot;nt&quot;&gt;-onetime&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-backend&lt;/span&gt; etcd &lt;span class=&quot;nt&quot;&gt;-node&lt;/span&gt; http://192.168.3.27:2379

&lt;span class=&quot;c&quot;&gt;## 间隔60s 刷新&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master ~]# confd &lt;span class=&quot;nt&quot;&gt;-interval&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;60 &lt;span class=&quot;nt&quot;&gt;-backend&lt;/span&gt; etcd &lt;span class=&quot;nt&quot;&gt;-node&lt;/span&gt; http://192.168.3.27:2379

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master ~]# &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /tmp/jevic.conf
upstream jevic&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
     server 127.0.0.1:5001&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

server &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    listen 80&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    server_name www.jevic.cn&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        location / &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            proxy_set_header Host &lt;span class=&quot;nv&quot;&gt;$host&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            proxy_set_header X-Real-IP &lt;span class=&quot;nv&quot;&gt;$remote_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            proxy_set_header X-Forwarded-For &lt;span class=&quot;nv&quot;&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            proxy_buffering off&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            proxy_pass http://jevic&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;转载请注明出处，本文采用 &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; 协议授权&lt;/p&gt;</content><author><name>Jevic</name></author><summary type="html">confd 下载 解压放到 /usr/local/bin 即可</summary></entry><entry><title type="html">etcd</title><link href="http://0.0.0.0/2018/01/31/etcd-setup/" rel="alternate" type="text/html" title="etcd" /><published>2018-01-31T14:39:25+08:00</published><updated>2018-01-31T14:39:25+08:00</updated><id>http://0.0.0.0/2018/01/31/etcd-setup</id><content type="html" xml:base="http://0.0.0.0/2018/01/31/etcd-setup/">&lt;p&gt;etcd 是 CoreOS 团队于 2013 年 6 月发起的开源项目，它的目标是构建一个高可用的分布式键值（key-value）数据库，基于 Go 语言实现。我们知道，在分布式系统中，各种服务的配置信息的管理分享，服务的发现是一个很基本同时也是很重要的问题。CoreOS 项目就希望基于 etcd 来解决这一问题。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://udn.yyuap.com/doc/docker_practice/_images/etcd_logo.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;简单：支持 REST 风格的 HTTP+JSON API&lt;/li&gt;
  &lt;li&gt;安全：支持 HTTPS 方式的访问&lt;/li&gt;
  &lt;li&gt;快速：支持并发 1k/s 的写操作&lt;/li&gt;
  &lt;li&gt;可靠：支持分布式结构，基于 Raft 的一致性算法&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;etcd&quot;&gt;etcd&lt;/h2&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;主机名&lt;/th&gt;
      &lt;th&gt;ip&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;etcd1&lt;/td&gt;
      &lt;td&gt;192.168.3.27&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;etcd2&lt;/td&gt;
      &lt;td&gt;192.168.3.28&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;etcd3&lt;/td&gt;
      &lt;td&gt;192.168.3.91&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;github-下载&quot;&gt;GitHub 下载&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/coreos/etcd/releases&quot;&gt;下载地址&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;下载解压到/usr/local/bin 即可&lt;/li&gt;
  &lt;li&gt;同步到所有主机&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://coreos.com/etcd/docs/latest/op-guide/clustering.html&quot;&gt;官网配置文档&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;static-集群运行脚本&quot;&gt;static 集群运行脚本&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;根据对应主机修改 &lt;code class=&quot;highlighter-rouge&quot;&gt;id&lt;/code&gt; 和 &lt;code class=&quot;highlighter-rouge&quot;&gt;LIP&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@Test-27 ~]# &lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;run.sh
&lt;span class=&quot;c&quot;&gt;## 根据主机名修改id&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1  
&lt;span class=&quot;c&quot;&gt;## 修改本地监听地址&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;LIP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.3.27
&lt;span class=&quot;c&quot;&gt;##&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;IP1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.3.27
&lt;span class=&quot;nv&quot;&gt;IP2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.3.28
&lt;span class=&quot;nv&quot;&gt;IP3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.3.91

etcd &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; etcd&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;-data-dir&lt;/span&gt; /var/lib/etcd
&lt;span class=&quot;nt&quot;&gt;--initial-advertise-peer-urls&lt;/span&gt; http://&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LIP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--listen-peer-urls&lt;/span&gt; http://0.0.0.0:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--listen-client-urls&lt;/span&gt; http://0.0.0.0:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--advertise-client-urls&lt;/span&gt; http://&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;LIP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;:2379 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--initial-cluster-token&lt;/span&gt; etcd-cluster-2 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--initial-cluster&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;etcd1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;IP1&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;:2380,etcd2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;IP2&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;:2380,etcd3&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;http://&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;IP3&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;:2380 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--initial-cluster-state&lt;/span&gt; new &lt;span class=&quot;nt&quot;&gt;--enable-pprof&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://coreos.com/etcd/docs/latest/op-guide/configuration.html&quot;&gt;配置详情&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;查看状态&quot;&gt;查看状态&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@Test-27 ~]# &lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ETCDCTL_API&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@Test-27 ~]# etcdctl &lt;span class=&quot;nt&quot;&gt;--write-out&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;table &lt;span class=&quot;nt&quot;&gt;--endpoints&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;localhost:2379 member list
+------------------+---------+-------+--------------------------+--------------------------+
|        ID        | STATUS  | NAME  |        PEER ADDRS        |       CLIENT ADDRS       |
+------------------+---------+-------+--------------------------+--------------------------+
| 6a4616e4ba4ebc49 | started | etcd1 | http://192.168.3.27:2380 | http://192.168.3.27:2379 |
| c80e270eacac1f06 | started | etcd3 | http://192.168.3.91:2380 | http://192.168.3.91:2379 |
| d9af56dd6a49a4fc | started | etcd2 | http://192.168.3.28:2380 | http://192.168.3.28:2379 |
+------------------+---------+-------+--------------------------+--------------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;dcmp&quot;&gt;dcmp&lt;/h2&gt;
&lt;blockquote&gt;
  &lt;p&gt;提供了一个etcd的管理界面，可通过界面修改配置信息，借助confd可实现配置文件的同步&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;docker-运行&quot;&gt;Docker 运行&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://hub.docker.com/r/jevic/etcd&quot;&gt;&lt;img src=&quot;https://img.shields.io/docker/pulls/jevic/etcd.svg&quot; alt=&quot;Docker Pulls&quot; /&gt;&lt;/a&gt;&lt;a href=&quot;https://hub.docker.com/r/jevic/etcd&quot;&gt;&lt;img src=&quot;https://img.shields.io/docker/stars/jevic/etcd.svg&quot; alt=&quot;Docker Stars&quot; /&gt;&lt;/a&gt;&lt;a href=&quot;https://microbadger.com/images/jevic/etcd&quot; title=&quot;Get your own image badge on microbadger.com&quot;&gt;&lt;img src=&quot;https://images.microbadger.com/badges/image/jevic/etcd.svg&quot; alt=&quot;&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;-e ETCD_HOST etcd服务地址,默认为 127.0.0.1&lt;/li&gt;
  &lt;li&gt;-e ROOT  配置根目录,默认为 /config 需要在etcd手动创建&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master ~]# etcdctl mkdir /config
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master ~]# docker run &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; dcmp &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 8000:8000 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ETCD_HOST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.3.27 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
jevic/etcd:dcmp
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;http://ok6h8mla5.bkt.clouddn.com/etcd-dcmp.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;转载请注明出处，本文采用 &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; 协议授权&lt;/p&gt;</content><author><name>Jevic</name></author><summary type="html">etcd 是 CoreOS 团队于 2013 年 6 月发起的开源项目，它的目标是构建一个高可用的分布式键值（key-value）数据库，基于 Go 语言实现。我们知道，在分布式系统中，各种服务的配置信息的管理分享，服务的发现是一个很基本同时也是很重要的问题。CoreOS 项目就希望基于 etcd 来解决这一问题。</summary></entry><entry><title type="html">elk Elasticsearch 分片丢失问题处理</title><link href="http://0.0.0.0/2018/01/23/elk-elasticsearch-shareds-error/" rel="alternate" type="text/html" title="elk Elasticsearch 分片丢失问题处理" /><published>2018-01-23T21:58:39+08:00</published><updated>2018-01-23T21:58:39+08:00</updated><id>http://0.0.0.0/2018/01/23/elk-elasticsearch-shareds-error</id><content type="html" xml:base="http://0.0.0.0/2018/01/23/elk-elasticsearch-shareds-error/">&lt;h1 id=&quot;问题概述&quot;&gt;问题概述&lt;/h1&gt;
&lt;blockquote&gt;
  &lt;p&gt;由于集群节点下线更换操作，导致了部分索引主分片丢失，集群处于red状态；
而且此时集群分片均衡失效，不在均衡数据；
尝试使用&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-reroute.html&quot;&gt;reroute API&lt;/a&gt; 接口来手动迁移，发现命令执行失败；
接下来就比较尴尬了….均衡不了….手动迁移也失败…. 
综合以上状况只能做以下操作了…&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;处理过程&quot;&gt;处理过程&lt;/h1&gt;
&lt;blockquote&gt;
  &lt;p&gt;将处于&lt;code class=&quot;highlighter-rouge&quot;&gt;red&lt;/code&gt;状态的并且过期不在使用的索引删除(此乃下下策😭)
保留并处理热门数据&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;1-重建索引&quot;&gt;1. 重建索引&lt;/h2&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-XPOST&lt;/span&gt; es-90:9200/_reindex &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'
{
  &quot;source&quot;: {
    &quot;index&quot;: &quot;index-name&quot;
  },
  &quot;dest&quot;: {
    &quot;index&quot;: &quot;index-name.bak&quot;
  }
}'&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;2-删除旧索引&quot;&gt;2. 删除旧索引&lt;/h2&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-XDELETE&lt;/span&gt; es-90:9200/index-name

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;3-建立别名&quot;&gt;3. 建立别名&lt;/h2&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-XPUT&lt;/span&gt; es-90:9200/index-name.bak/_alias/index-name
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;批量处理&quot;&gt;批量处理&lt;/h1&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;indexs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;index1 index2 index3&quot;&lt;/span&gt;

back&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;-XPOST&lt;/span&gt; es-90:9200/_reindex &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'
{
  &quot;source&quot;: {
    &quot;index&quot;: &quot;'&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$index&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'&quot;
  },
  &quot;dest&quot;: {
    &quot;index&quot;: &quot;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;.bak&lt;span class=&quot;s1&quot;&gt;'&quot;
  }
}'&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;index &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$indexs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;do
    &lt;/span&gt;back
    curl &lt;span class=&quot;nt&quot;&gt;-XDELETE&lt;/span&gt; es-90:9200/&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
    curl &lt;span class=&quot;nt&quot;&gt;-XPUT&lt;/span&gt; es-90:9200/&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;.bak/_alias/&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;副本丢失&quot;&gt;副本丢失&lt;/h1&gt;
&lt;blockquote&gt;
  &lt;p&gt;当索引副本分片丢失 且无法正常均衡时&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;1-取消副本&quot;&gt;1. 取消副本&lt;/h2&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT /test/_settings
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;index&quot;&lt;/span&gt; : &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;number_of_replicas&quot;&lt;/span&gt; : 0
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;2-恢复副本&quot;&gt;2. 恢复副本&lt;/h2&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
PUT /test/_settings
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;index&quot;&lt;/span&gt; : &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;number_of_replicas&quot;&lt;/span&gt; : 1
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;转载请注明出处，本文采用 &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; 协议授权&lt;/p&gt;</content><author><name>Jevic</name></author><summary type="html">问题概述 由于集群节点下线更换操作，导致了部分索引主分片丢失，集群处于red状态； 而且此时集群分片均衡失效，不在均衡数据； 尝试使用reroute API 接口来手动迁移，发现命令执行失败； 接下来就比较尴尬了….均衡不了….手动迁移也失败…. 综合以上状况只能做以下操作了…</summary></entry><entry><title type="html">elk Elasticsearch Unassigned Shards 无法reroute问题处理</title><link href="http://0.0.0.0/2018/01/23/elasticsearch-unassigned-shared/" rel="alternate" type="text/html" title="elk Elasticsearch Unassigned Shards 无法reroute问题处理" /><published>2018-01-23T18:53:02+08:00</published><updated>2018-01-23T18:53:02+08:00</updated><id>http://0.0.0.0/2018/01/23/elasticsearch-unassigned-shared</id><content type="html" xml:base="http://0.0.0.0/2018/01/23/elasticsearch-unassigned-shared/">&lt;h1 id=&quot;问题概述&quot;&gt;问题概述&lt;/h1&gt;
&lt;blockquote&gt;
  &lt;p&gt;由于集群节点下线更换操作，导致了部分索引主分片丢失，集群处于red状态；&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;而且此时集群分片均衡失效，不在均衡数据；&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;尝试使用&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-reroute.html&quot;&gt;reroute API&lt;/a&gt; 接口来手动迁移，发现命令执行失败；&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;接下来就比较尴尬了….均衡不了….手动迁移也失败….&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;综合以上状况只能做以下操作了…&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;处理过程&quot;&gt;处理过程&lt;/h1&gt;
&lt;blockquote&gt;
  &lt;p&gt;将处于&lt;code class=&quot;highlighter-rouge&quot;&gt;red&lt;/code&gt;状态的并且过期不在使用的索引删除(此乃下下策😭)
 保留并处理热门数据&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;1-重建索引&quot;&gt;1. 重建索引&lt;/h2&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-XPOST&lt;/span&gt; es-90:9200/_reindex &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'
{
  &quot;source&quot;: {
    &quot;index&quot;: &quot;index-name&quot;
  },
  &quot;dest&quot;: {
    &quot;index&quot;: &quot;index-name.bak&quot;
  }
}'&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;2-删除旧索引&quot;&gt;2. 删除旧索引&lt;/h2&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-XDELETE&lt;/span&gt; es-90:9200/index-name

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;3-建立别名&quot;&gt;3. 建立别名&lt;/h2&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl &lt;span class=&quot;nt&quot;&gt;-XPUT&lt;/span&gt; es-90:9200/index-name.bak/_alias/index-name
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;批量处理&quot;&gt;批量处理&lt;/h1&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;indexs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;index1 index2 index3&quot;&lt;/span&gt;

back&lt;span class=&quot;o&quot;&gt;(){&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;-XPOST&lt;/span&gt; es-90:9200/_reindex &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'
{
  &quot;source&quot;: {
    &quot;index&quot;: &quot;'&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$index&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'&quot;
  },
  &quot;dest&quot;: {
    &quot;index&quot;: &quot;'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;.bak&lt;span class=&quot;s1&quot;&gt;'&quot;
  }
}'&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;index &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$indexs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;do
    &lt;/span&gt;back
    curl &lt;span class=&quot;nt&quot;&gt;-XDELETE&lt;/span&gt; es-90:9200/&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
    curl &lt;span class=&quot;nt&quot;&gt;-XPUT&lt;/span&gt; es-90:9200/&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;.bak/_alias/&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;副本丢失&quot;&gt;副本丢失&lt;/h1&gt;
&lt;blockquote&gt;
  &lt;p&gt;当索引副本分片丢失 且无法正常均衡时&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;1-取消副本&quot;&gt;1. 取消副本&lt;/h2&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;PUT /test/_settings
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;index&quot;&lt;/span&gt; : &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;number_of_replicas&quot;&lt;/span&gt; : 0
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;2-恢复副本&quot;&gt;2. 恢复副本&lt;/h2&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
PUT /test/_settings
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;index&quot;&lt;/span&gt; : &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;number_of_replicas&quot;&lt;/span&gt; : 1
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;后记&quot;&gt;后记&lt;/h1&gt;
&lt;blockquote&gt;
  &lt;p&gt;在扩容下线 更换节点时 务必单个节点逐一操作&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;节点更新或下线&quot;&gt;节点更新或下线&lt;/h2&gt;
&lt;ol&gt;
  &lt;li&gt;关闭均衡&lt;/li&gt;
  &lt;li&gt;设置此节点不在运行数据写入&lt;/li&gt;
  &lt;li&gt;重启或停用节点&lt;/li&gt;
  &lt;li&gt;开启均衡&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;转载请注明出处，本文采用 &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; 协议授权&lt;/p&gt;</content><author><name>Jevic</name></author><summary type="html">问题概述 由于集群节点下线更换操作，导致了部分索引主分片丢失，集群处于red状态；</summary></entry><entry><title type="html">zookeeper</title><link href="http://0.0.0.0/2018/01/18/bigdata-zookeeper-conf/" rel="alternate" type="text/html" title="zookeeper" /><published>2018-01-18T16:11:08+08:00</published><updated>2018-01-18T16:11:08+08:00</updated><id>http://0.0.0.0/2018/01/18/bigdata-zookeeper-conf</id><content type="html" xml:base="http://0.0.0.0/2018/01/18/bigdata-zookeeper-conf/">&lt;p&gt;&lt;img src=&quot;http://zookeeper.apache.org/images/feather_small.gif&quot; alt=&quot;image&quot; /&gt;Apache ZooKeeper™
&lt;img src=&quot;http://zookeeper.apache.org/images/zookeeper_small.gif&quot; alt=&quot;image&quot; /&gt;&lt;/p&gt;
&lt;h3 id=&quot;简介&quot;&gt;简介&lt;/h3&gt;

&lt;p&gt;Apache Zookeeper 是由 Apache Hadoop 的 Zookeeper 子项目发展而来，现在已经成为了 Apache 的顶级项目。Zookeeper 为分布式系统提供了高效可靠且易于使用的协同服务，它可以为分布式应用提供相当多的服务，诸如统一命名服务，配置管理，状态同步和组服务等。Zookeeper 接口简单，开发人员不必过多地纠结在分布式系统编程难于处理的同步和一致性问题上，你可以使用 Zookeeper 提供的现成(off-the-shelf)服务来实现分布式系统的配置管理，组管理，Leader 选举等功能。&lt;/p&gt;

&lt;p&gt;Zookeeper 维护了大规模分布式系统中的常用对象，比如配置信息，层次化命名空间等，本文将从开发者的角度详细介绍 Zookeeper 的配置信息的意义以及 Zookeeper 的典型应用场景（配置文件的管理、集群管理、分布式队列、同步锁、Leader 选举、队列管理等）。&lt;/p&gt;

&lt;h3 id=&quot;zookeeper-安装与配置&quot;&gt;Zookeeper 安装与配置&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;本文采用 &lt;code class=&quot;highlighter-rouge&quot;&gt;Zookeeper-3.4.9&lt;/code&gt; 介绍它的安装步骤以及配置信息，最新的代码可以到 Zookeeper 的&lt;a href=&quot;http://apache.fayea.com/zookeeper/&quot;&gt;官网下载&lt;/a&gt;：&lt;/li&gt;
  &lt;li&gt;Zookeeper功能强大，但是安装却十分简单，下面重点以伪分布式模式来介绍 Zookeeper 的安装。&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;Zookeeper 安装模式包括：&lt;code class=&quot;highlighter-rouge&quot;&gt;单机模式&lt;/code&gt;，&lt;code class=&quot;highlighter-rouge&quot;&gt;伪分布式模式&lt;/code&gt;和&lt;code class=&quot;highlighter-rouge&quot;&gt;完全的集群模式&lt;/code&gt;。
单机模式最简单本文跳过（单机模式安装步骤参见 Zeekeeper &lt;a href=&quot;http://zookeeper.apache.org/doc/current/zookeeperStarted.html&quot;&gt;官方文档&lt;/a&gt;）
伪分布式模式与集群模式配置差别不大! 为了帮助大家理解所以本文采用单台虚拟机来配置伪分布集群，
后续大家如果熟悉后建议使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;Docker&lt;/code&gt; 提供的&lt;a href=&quot;https://hub.docker.com/&quot;&gt;官方镜像&lt;/a&gt;来配置集群环境&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;本文在 &lt;code class=&quot;highlighter-rouge&quot;&gt;CentOS 7.2&lt;/code&gt; 上操作&lt;/li&gt;
  &lt;li&gt;Java 环境为 &lt;code class=&quot;highlighter-rouge&quot;&gt;jdk1.8.0_111&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;安装 Zookeeper 前首先下载你需要的版本，暂时解压到指定目录
本文解压至 &lt;code class=&quot;highlighter-rouge&quot;&gt;/opt/source/&lt;/code&gt; 目录下，本次伪分布式模拟 &lt;code class=&quot;highlighter-rouge&quot;&gt;3&lt;/code&gt; 个 Zookeeper，目录分配如下：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;mkdir /opt/source
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;tar &lt;/span&gt;zxf /home/zookeeper-3.4.9.tar.gz &lt;span class=&quot;nt&quot;&gt;-C&lt;/span&gt; /opt/source
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;cp &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; zookeeper zookeeper2 &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; cp &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; zookeeper zookeeper3
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;tree &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; 1
&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
├── zookeeper
├── zookeeper2
└── zookeeper3
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;tree &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; 1 /data
/data
├── zookeeper
├── zookeeper2
└── zookeeper3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;zookeeper-配置文件&quot;&gt;Zookeeper 配置文件&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;这里我们只介绍 zoo_sample.cfg，首先将此文件重命名为&lt;code class=&quot;highlighter-rouge&quot;&gt;zoo.cfg&lt;/code&gt;，并修改对应目录下的zoo.cfg。整体配置其实很简单所以这里只列出了配置后启用参数，具体参数的说明请参考官方文档这里不在叙述：&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;egrep &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;^#|^$&quot;&lt;/span&gt; zookeeper/conf/zoo.cfg 
&lt;span class=&quot;nv&quot;&gt;tickTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2000
&lt;span class=&quot;nv&quot;&gt;initLimit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10
&lt;span class=&quot;nv&quot;&gt;syncLimit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;5
&lt;span class=&quot;nv&quot;&gt;dataDir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/data/zookeeper
&lt;span class=&quot;nv&quot;&gt;clientPort&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2181
server.1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;master:3331:4881
server.2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;master:3332:4882
server.3&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;master:3333:4883
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;egrep &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;^#|^$&quot;&lt;/span&gt; zookeeper2/conf/zoo.cfg 
&lt;span class=&quot;nv&quot;&gt;tickTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2000
&lt;span class=&quot;nv&quot;&gt;initLimit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10
&lt;span class=&quot;nv&quot;&gt;syncLimit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;5
&lt;span class=&quot;nv&quot;&gt;dataDir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/data/zookeeper2
&lt;span class=&quot;nv&quot;&gt;clientPort&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2182
server.1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;master:3331:4881
server.2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;master:3332:4882
server.3&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;master:3333:4883
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;egrep &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;^#|^$&quot;&lt;/span&gt; zookeeper3/conf/zoo.cfg 
&lt;span class=&quot;nv&quot;&gt;tickTime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2000
&lt;span class=&quot;nv&quot;&gt;initLimit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10
&lt;span class=&quot;nv&quot;&gt;syncLimit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;5
&lt;span class=&quot;nv&quot;&gt;dataDir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/data/zookeeper3
&lt;span class=&quot;nv&quot;&gt;clientPort&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2183
server.1&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;master:3331:4881
server.2&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;master:3332:4882
server.3&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;master:3333:4883

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;1&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /data/zookeeper/myid
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;2&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /data/zookeeper2/myid
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;3&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /data/zookeeper3/myid

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;启动服务&quot;&gt;启动服务&lt;/h4&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;/opt/source/zookeeper/bin/zkServer.sh start
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;/opt/source/zookeeper2/bin/zkServer.sh start
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;/opt/source/zookeeper3/bin/zkServer.sh start
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;参数说明&quot;&gt;参数说明&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;tickTime：这个时间是作为 Zookeeper 服务器之间或客户端与服务器之间维持心跳的时间间隔，也就是每个 tickTime 时间就会发送一个心跳。&lt;/li&gt;
  &lt;li&gt;dataDir：顾名思义就是 Zookeeper 保存数据的目录，默认情况下，Zookeeper 将写数据的日志文件也保存在这个目录里。&lt;/li&gt;
  &lt;li&gt;clientPort：这个端口就是客户端连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求。&lt;/li&gt;
  &lt;li&gt;initLimit：这个配置项是用来配置 Zookeeper 接受客户端
    &lt;ul&gt;
      &lt;li&gt;（这里所说的客户端不是用户连接 Zookeeper 服务器的客户端，
而是 Zookeeper 服务器集群中连接到 Leader 的 Follower 服务器）初始化连接时最长能忍受多少个心跳时间间隔数。&lt;/li&gt;
      &lt;li&gt;当已经超过 5个心跳的时间（也就是 tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 5*2000=10 秒&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;syncLimit：这个配置项标识 Leader 与Follower 之间发送消息，请求和应答时间长度，最长不能超过多少个 tickTime 的时间长度，总的时间长度就是2*2000=4 秒
server.A=B：C：D：
    &lt;ul&gt;
      &lt;li&gt;其中 A 是一个数字，表示这个是第几号服务器；&lt;/li&gt;
      &lt;li&gt;B 是这个服务器的 ip 地址；&lt;/li&gt;
      &lt;li&gt;C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；&lt;/li&gt;
      &lt;li&gt;D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。&lt;/li&gt;
      &lt;li&gt;如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信端口号不能一样，所以要给它们分配不同的端口号&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;服务查看&quot;&gt;服务查看&lt;/h3&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;netstat &lt;span class=&quot;nt&quot;&gt;-tnlp&lt;/span&gt; |grep &lt;span class=&quot;s1&quot;&gt;'java'&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
tcp        0      0 192.168.11.130:4881     0.0.0.0:&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;               LISTEN      3751/java           
tcp        0      0 192.168.11.130:4882     0.0.0.0:&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;               LISTEN      3779/java           
tcp        0      0 192.168.11.130:4883     0.0.0.0:&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;               LISTEN      3820/java           
tcp        0      0 0.0.0.0:52021           0.0.0.0:&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;               LISTEN      3820/java           
tcp        0      0 0.0.0.0:42968           0.0.0.0:&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;               LISTEN      3751/java           
tcp        0      0 0.0.0.0:45241           0.0.0.0:&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;               LISTEN      3779/java           
tcp        0      0 192.168.11.130:3332     0.0.0.0:&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;               LISTEN      3779/java           
tcp        0      0 0.0.0.0:2181            0.0.0.0:&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;               LISTEN      3751/java           
tcp        0      0 0.0.0.0:2182            0.0.0.0:&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;               LISTEN      3779/java           
tcp        0      0 0.0.0.0:2183            0.0.0.0:&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;               LISTEN      3820/java

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;验证测试&quot;&gt;验证测试&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;/opt/source/zookeeper/bin/zkCli.sh &lt;span class=&quot;nt&quot;&gt;-server&lt;/span&gt; master:2181
Welcome to ZooKeeper!
JLine support is enabled
2016-12-26 15:20:48,698 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;myid:] - INFO  &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;main-SendThread&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master:2181&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:ClientCnxn&lt;span class=&quot;nv&quot;&gt;$SendThread&lt;/span&gt;@876] - Socket conn
ection established to master/192.168.11.130:2181, initiating session2016-12-26 15:20:48,725 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;myid:] - INFO  &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;main-SendThread&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master:2181&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:ClientCnxn&lt;span class=&quot;nv&quot;&gt;$SendThread&lt;/span&gt;@1299] - Session es
tablishment &lt;span class=&quot;nb&quot;&gt;complete &lt;/span&gt;on server master/192.168.11.130:2181, sessionid &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 0x15939ddfedb0001, negotiated timeout &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 30000
WATCHER::
WatchedEvent state:SyncConnected &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;:None path:null
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;zk: master:2181&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;CONNECTED&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 1] create /test 123

另开一个终端：
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@master ~]# /opt/source/zookeeper3/bin/zkCli.sh &lt;span class=&quot;nt&quot;&gt;-server&lt;/span&gt; master:2183
Welcome to ZooKeeper!
JLine support is enabled
2016-12-26 15:21:40,669 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;myid:] - INFO  &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;main-SendThread&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master:2183&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:ClientCnxn&lt;span class=&quot;nv&quot;&gt;$SendThread&lt;/span&gt;@876] - Socket conn
ection established to master/192.168.11.130:2183, initiating session2016-12-26 15:21:40,691 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;myid:] - INFO  &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;main-SendThread&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;master:2183&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:ClientCnxn&lt;span class=&quot;nv&quot;&gt;$SendThread&lt;/span&gt;@1299] - Session es
tablishment &lt;span class=&quot;nb&quot;&gt;complete &lt;/span&gt;on server master/192.168.11.130:2183, sessionid &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 0x35939de0e410001, negotiated timeout &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 30000
WATCHER::
WatchedEvent state:SyncConnected &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;:None path:null
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;zk: master:2183&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;CONNECTED&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 1] get /test
123
cZxid &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 0x100000009
ctime &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Mon Dec 26 15:21:12 CST 2016
mZxid &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 0x100000009
mtime &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; Mon Dec 26 15:21:12 CST 2016
pZxid &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 0x100000009
cversion &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 0
dataVersion &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 0
aclVersion &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 0
ephemeralOwner &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 0x0
dataLength &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 4
numChildren &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;更多详细信息请查看&lt;a href=&quot;http://zookeeper.apache.org/doc/r3.4.9/&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;转载请注明出处，本文采用 &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; 协议授权&lt;/p&gt;</content><author><name>Jevic</name></author><summary type="html">Apache ZooKeeper™ 简介</summary></entry><entry><title type="html">hadoop HDFS Datanode 节点动态扩展(二)</title><link href="http://0.0.0.0/2018/01/18/hadoop-hdfs-datanode/" rel="alternate" type="text/html" title="hadoop HDFS Datanode 节点动态扩展(二)" /><published>2018-01-18T15:37:37+08:00</published><updated>2018-01-18T15:37:37+08:00</updated><id>http://0.0.0.0/2018/01/18/hadoop-hdfs-datanode</id><content type="html" xml:base="http://0.0.0.0/2018/01/18/hadoop-hdfs-datanode/">&lt;h2 id=&quot;扩容-datanode&quot;&gt;扩容 Datanode&lt;/h2&gt;
&lt;ol&gt;
  &lt;li&gt;增加hostname,同步/etc/hosts 到所有节点,配置双机互信&lt;/li&gt;
  &lt;li&gt;添加主机名到主节点的 slave 文件中&lt;/li&gt;
  &lt;li&gt;同步主节点Hadoop 运行目录到新增Datanode 节点 并修改权限&lt;/li&gt;
  &lt;li&gt;创建数据目录并修改权限&lt;/li&gt;
  &lt;li&gt;启动datanode&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;配置互信-hostname-slave&quot;&gt;配置互信 hostname slave&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-node3 .ssh]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;pwd&lt;/span&gt;
/home/hadoop/.ssh
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-node3 .ssh]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls
&lt;/span&gt;authorized_keys  id_rsa 

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]# &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /etc/hosts |grep hdfs
192.168.3.27 hdfs-master
192.168.3.28 hdfs-slave
192.168.3.91 hdfs-node3
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]# scp /etc/hosts hdfs-slave:/etc/hosts
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]# scp /etc/hosts hdfs-node3:/etc/hosts
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]# &lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /usr/local/hadoop/etc/hadoop/slaves
hdfs-master
hdfs-slave
hdfs-node3
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]# scp /usr/local/hadoop/etc/hadoop/slaves hdfs-slave:/usr/local/hadoop/etc/hadoop/slaves

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;同步hadoop运行目录&quot;&gt;同步Hadoop运行目录&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[hadoop@hdfs-master ~]# scp /usr/local/hadoop hdfs-node3:/usr/local/

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;创建目录并修改权限&quot;&gt;创建目录并修改权限&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@hdfs-node3 &lt;span class=&quot;nb&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# chown -R hadoop.hadoop hadoop&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@hdfs-node3 &lt;span class=&quot;nb&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# mkdir -p /data/hadoop/data/{dfs,tmp,yarn}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@hdfs-node3 &lt;span class=&quot;nb&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# mkdir -p /data/hadoop/data/dfs/data&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@hdfs-node3 &lt;span class=&quot;nb&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# chown -R hadoop.hadoop /data/hadoop&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;启动-datanode&quot;&gt;启动 datanode&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-node3 hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./sbin/hadoop-daemon.sh start datanode
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;master节点查看当前集群信息-确认新节点已经加入&quot;&gt;master节点查看当前集群信息 确认新节点已经加入&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;hdfs dfsadmin &lt;span class=&quot;nt&quot;&gt;-report&lt;/span&gt;
Configured Capacity: 548221317120 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;510.57 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Present Capacity: 446565990400 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;415.90 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
DFS Remaining: 446516936704 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;415.85 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
DFS Used: 49053696 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;46.78 MB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
DFS Used%: 0.01%
Under replicated blocks: 0
Blocks with corrupt replicas: 0
Missing blocks: 0
Missing blocks &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;with replication factor 1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;: 0

&lt;span class=&quot;nt&quot;&gt;-------------------------------------------------&lt;/span&gt;
Live datanodes &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:

Name: 192.168.3.27:50010 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;hdfs-master&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Hostname: hdfs-master
Decommission Status : Normal
Configured Capacity: 440899563520 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;410.62 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
DFS Used: 16351232 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;15.59 MB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Non DFS Used: 21774798848 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;20.28 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
DFS Remaining: 419108413440 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;390.33 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
DFS Used%: 0.00%
DFS Remaining%: 95.06%
Configured Cache Capacity: 0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0 B&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Cache Used: 0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0 B&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Cache Remaining: 0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0 B&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Cache Used%: 100.00%
Cache Remaining%: 0.00%
Xceivers: 1
Last contact: Tue Jan 16 14:03:18 CST 2018


Name: 192.168.3.91:50010 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;hdfs-node3&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Hostname: hdfs-node3
Decommission Status : Normal
Configured Capacity: 53660876800 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;49.98 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
DFS Used: 16351232 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;15.59 MB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Non DFS Used: 37875245056 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;35.27 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
DFS Remaining: 15769280512 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;14.69 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
DFS Used%: 0.03%
DFS Remaining%: 29.39%
Configured Cache Capacity: 0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0 B&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Cache Used: 0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0 B&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Cache Remaining: 0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0 B&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Cache Used%: 100.00%
Cache Remaining%: 0.00%
Xceivers: 1
Last contact: Tue Jan 16 14:03:16 CST 2018


Name: 192.168.3.28:50010 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;hdfs-slave&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Hostname: hdfs-slave
Decommission Status : Normal
Configured Capacity: 53660876800 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;49.98 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
DFS Used: 16351232 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;15.59 MB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Non DFS Used: 42005282816 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;39.12 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
DFS Remaining: 11639242752 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;10.84 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
DFS Used%: 0.03%
DFS Remaining%: 21.69%
Configured Cache Capacity: 0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0 B&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Cache Used: 0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0 B&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Cache Remaining: 0 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0 B&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Cache Used%: 100.00%
Cache Remaining%: 0.00%
Xceivers: 1
Last contact: Tue Jan 16 14:03:18 CST 2018

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;master节点开启负载均衡&quot;&gt;master节点开启负载均衡&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;hdfs dfsadmin &lt;span class=&quot;nt&quot;&gt;-setBalancerBandwidth&lt;/span&gt; 67108864
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;start-balancer.sh &lt;span class=&quot;nt&quot;&gt;-threshold&lt;/span&gt; 5
starting balancer, logging to /usr/local/hadoop/logs/hadoop-hadoop-balancer-hdfs-master.out
Time Stamp               Iteration#  Bytes Already Moved  Bytes Left To Move  Bytes Being Moved
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;新节点启动nodemanager&quot;&gt;新节点启动nodemanager&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-node3 hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./sbin/yarn-daemon.sh start nodemanager
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;datanode-节点退役&quot;&gt;Datanode 节点退役&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;hdfs-site.xml 必须配置此部分&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;tail &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; 5 hdfs-site.xml
　　&amp;lt;property&amp;gt;
　　    &amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--dfs&lt;/span&gt;.hosts.exclude定义的文件内容为,每个需要下线的机器，一行一个--&amp;gt;
        &amp;lt;name&amp;gt;dfs.hosts.exclude&amp;lt;/name&amp;gt;
　      &amp;lt;value&amp;gt;/usr/local/hadoop/etc/hadoop/excludes&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
&amp;lt;/configuration&amp;gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;excludes-文件&quot;&gt;excludes 文件&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;在 $HADOOP_HOME/etc/hadoop/excludes 中配置想要退役的节点，一行一个
如果配置了HA 则需要同步到standby 节点&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[hadoop@hdfs-master hadoop]$ scp excludes hdfs-slave:/usr/local/hadoop/etc/hadoop/
[hadoop@hdfs-master hadoop]$ cat excludes
hdfs-node4
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;然后在namenode 节点执行 刷新&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;hdfs dfsadmin &lt;span class=&quot;nt&quot;&gt;-refreshNodes&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;查看web 界面发现节点已经退役状态&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;恢复节点&quot;&gt;恢复节点&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;当退役节点维护完毕 需要重新恢复到集群时&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
  &lt;li&gt;重启datanode&lt;/li&gt;
  &lt;li&gt;查看并确认 DataNode节点已经加入&lt;/li&gt;
  &lt;li&gt;启动 nodemanager 即可&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;注意: 当启动或重启 &lt;code class=&quot;highlighter-rouge&quot;&gt;namenode&lt;/code&gt; 节点时务必把 &lt;code class=&quot;highlighter-rouge&quot;&gt;excludes&lt;/code&gt; 文件清空后再进行操作
一定要注意操作的顺序 否则会报错&lt;/p&gt;
&lt;/blockquote&gt;</content><author><name>Jevic</name></author><summary type="html">扩容 Datanode 增加hostname,同步/etc/hosts 到所有节点,配置双机互信 添加主机名到主节点的 slave 文件中 同步主节点Hadoop 运行目录到新增Datanode 节点 并修改权限 创建数据目录并修改权限 启动datanode</summary></entry><entry><title type="html">hadoop HDFS HA 高可用配置(一)</title><link href="http://0.0.0.0/2018/01/18/hadoop-ha-config/" rel="alternate" type="text/html" title="hadoop HDFS HA 高可用配置(一)" /><published>2018-01-18T15:35:27+08:00</published><updated>2018-01-18T15:35:27+08:00</updated><id>http://0.0.0.0/2018/01/18/hadoop-ha-config</id><content type="html" xml:base="http://0.0.0.0/2018/01/18/hadoop-ha-config/">&lt;p&gt;&lt;img src=&quot;http://hadoop.apache.org/images/hadoop-logo.jpg&quot; alt=&quot;Hadoop&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;概述&quot;&gt;概述&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;Hadoop是一个由Apache基金会所开发的分布式系统基础架构。
用户可以在不了解分布式底层细节的情况下，开发分布式程序。充分利用集群的威力进行高速运算和存储。&lt;/li&gt;
  &lt;li&gt;Hadoop实现了一个分布式文件系统（Hadoop Distributed File System），简称HDFS。HDFS有高容错性的特点，并且设计用来部署在低廉的（low-cost）硬件上；而且它提供高吞吐量（high throughput）来访问应用程序的数据，适合那些有着超大数据集（large data set）的应用程序。&lt;/li&gt;
  &lt;li&gt;HDFS放宽了（relax）POSIX的要求，可以以流的形式访问（streaming access）文件系统中的数据。&lt;/li&gt;
  &lt;li&gt;Hadoop的框架最核心的设计就是：HDFS和MapReduce。&lt;/li&gt;
  &lt;li&gt;HDFS为海量的数据提供了存储，则MapReduce为海量的数据提供了计算。&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;Hadoop2.x之后的版本提供了解决单点问题的方案－HA(HighAvailable 高可用) 执行步骤如下：&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;配置-hdfs-ha&quot;&gt;配置 HDFS HA&lt;/h3&gt;
&lt;h4 id=&quot;依赖组件下载&quot;&gt;依赖组件下载&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html&quot;&gt;JDK&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://zookeeper.apache.org/releases.html&quot;&gt;zookeeper&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://apache.fayea.com/hadoop/common/&quot;&gt;hadoop2.x&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;初始化主机&quot;&gt;初始化主机&lt;/h4&gt;
&lt;ol&gt;
  &lt;li&gt;hostname&lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;192.168.3.27 hdfs-master
192.168.3.28 hdfs-slave

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;关闭防火墙 selinux&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;创建 hadoop 用户&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;ulimit&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# cat /etc/security/limits.conf&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; soft nofile 102400
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; hard nofile 102400
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;配置 hadoop 用户双机互信&lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ssh-keygen &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; rsa
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; .ssh/id_rsa.pub &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; .ssh/authorized_keys
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;chmod 600 .ssh/authorized_keys
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;
复制master 公钥到各节点 步骤略.......
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;jdk&quot;&gt;jdk&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;/opt/jdk&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /etc/profile
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;JAVA_HOME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/opt/jdk
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;JAVA_HOME&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/bin:&lt;span class=&quot;nv&quot;&gt;$PATH&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CLASSPATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;.:&lt;span class=&quot;nv&quot;&gt;$JAVA_HOME&lt;/span&gt;/jre/lib/rt.jar:&lt;span class=&quot;nv&quot;&gt;$JAVA_HOME&lt;/span&gt;/jre/lib/dt.jar:&lt;span class=&quot;nv&quot;&gt;$JAVA_HOME&lt;/span&gt;/lib/tools.jar

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;zookeeper&quot;&gt;zookeeper&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.jevic.cn/categories/#Bigdata&quot;&gt;zookeeper 配置实例&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;hadoop&quot;&gt;Hadoop&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;/usr/local/hadoop&lt;/li&gt;
&lt;/ul&gt;

&lt;h5 id=&quot;创建目录所有节点&quot;&gt;创建目录(所有节点)&lt;/h5&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# mkdir -p /data/hadoop/data/{dfs,tmp,yarn}&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# mkdir -p /data/hadoop/data/dfs/{data,name}&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# chown -R hadoop.hadoop /data/hadoop&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;编辑配置文件&quot;&gt;编辑配置文件&lt;/h5&gt;

&lt;h6 id=&quot;切换到hadoop-用户操作&quot;&gt;切换到hadoop 用户操作&lt;/h6&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@hdfs-master ~]# su - hadoop
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master ~]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /usr/local/hadoop/etc/hadoop/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h6 id=&quot;hadoop-envsh&quot;&gt;hadoop-env.sh&lt;/h6&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;JAVA_HOME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/opt/jdk
&lt;span class=&quot;c&quot;&gt;#export HADOOP_SSH_OPTS=&quot;-p 22&quot; 默认为22&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h6 id=&quot;slave&quot;&gt;slave&lt;/h6&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;slaves
hdfs-master
hdfs-slave
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;core-siteyml&quot;&gt;core-site.yml&lt;/h6&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;core-site.xml
&amp;lt;?xml &lt;span class=&quot;nv&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1.0&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;encoding&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;?&amp;gt;
&amp;lt;?xml-stylesheet &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;text/xsl&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;configuration.xsl&quot;&lt;/span&gt;?&amp;gt;
&amp;lt;configuration&amp;gt;
&amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;fs.defaultFS&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs://hadoop-node&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;io.file.buffer.size&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;131072&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;hadoop.tmp.dir&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;/data/hadoop/tmp&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;hadoop.proxyuser.hduser.hosts&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;hadoop.proxyuser.hduser.groups&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;ha.zookeeper.quorum&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master:2181&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
&amp;lt;/configuration&amp;gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;hdfs-sitexml&quot;&gt;hdfs-site.xml&lt;/h6&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;hdfs-site.xml
&amp;lt;?xml &lt;span class=&quot;nv&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1.0&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;encoding&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;?&amp;gt;
&amp;lt;?xml-stylesheet &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;text/xsl&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;configuration.xsl&quot;&lt;/span&gt;?&amp;gt;
&amp;lt;configuration&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.nameservices&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hadoop-node&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.ha.namenodes.hadoop-node&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;nmaster,nslave&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.namenode.rpc-address.hadoop-node.nmaster&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master:9000&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.namenode.rpc-address.hadoop-node.nslave&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-slave:9000&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;

    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.namenode.http-address.hadoop-node.nmaster&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master:50070&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;

    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.namenode.http-address.hadoop-node.nslave&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-slave:50070&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.namenode.shared.edits.dir&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;qjournal://hdfs-master:8485&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;hdfs-slave:8485/hadoop-node&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;

    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.client.failover.proxy.provider.hadoop-node&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.ha.fencing.methods&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;sshfence&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.ha.fencing.ssh.private-key-files&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;/home/hadoop/.ssh/id_rsa&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.journalnode.edits.dir&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;/data/hadoop/data/tmp/journal&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.ha.automatic-failover.enabled&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;true&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.namenode.name.dir&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;/data/hadoop/data/dfs/name&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.datanode.data.dir&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;/data/hadoop/data/dfs/data&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.replication&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;3&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.webhdfs.enabled&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;true&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.journalnode.http-address&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;0.0.0.0:8480&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.journalnode.rpc-address&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;0.0.0.0:8485&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;ha.zookeeper.quorum&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;Test-27:2181&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.datanode.data.dir.perm&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;755&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;dfs.block.local-path-access.user&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hadoop,root&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
　　    &amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--dfs&lt;/span&gt;.hosts.exclude定义的文件内容为,每个需要下线的机器，一行一个--&amp;gt;
        &amp;lt;name&amp;gt;dfs.hosts.exclude&amp;lt;/name&amp;gt;
　      &amp;lt;value&amp;gt;/usr/local/hadoop/etc/hadoop/excludes&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
&amp;lt;/configuration&amp;gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;mapred-sitexml&quot;&gt;mapred-site.xml&lt;/h6&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;mapred-site.xml
&amp;lt;?xml &lt;span class=&quot;nv&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1.0&quot;&lt;/span&gt;?&amp;gt;
&amp;lt;?xml-stylesheet &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;text/xsl&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;href&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;configuration.xsl&quot;&lt;/span&gt;?&amp;gt;
&amp;lt;configuration&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;mapreduce.framework.name&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;yarn&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;mapreduce.jobhistory.address&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;nmaster:10020&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;mapreduce.jobhistory.webapp.address&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;nmaster:19888&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
&amp;lt;/configuration&amp;gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h6 id=&quot;yarn-sitexml&quot;&gt;yarn-site.xml&lt;/h6&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;yarn-site.xml
&amp;lt;?xml &lt;span class=&quot;nv&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1.0&quot;&lt;/span&gt;?&amp;gt;
&amp;lt;configuration&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.connect.retry-interval.ms&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;2000&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.ha.enabled&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;true&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.ha.rm-ids&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;rm1,rm2&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;ha.zookeeper.quorum&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master:2181&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;

    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.ha.automatic-failover.enabled&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;true&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.hostname.rm1&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;

    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.hostname.rm2&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-slave&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;在hdfs-master上配置rm1,在hdfs-slave上配置rm2,注意：一般都喜欢把配置好的文件远程复制到其它机器上，但这个在YARN的另一个机器上一定要修改 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.ha.id&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;rm1&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;开启自动恢复功能 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.recovery.enabled&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;true&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;配置与zookeeper的连接地址 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.zk-state-store.address&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master:2181&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.store.class&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;org.apache.hadoop.yarn.server.resourcemanager.recovery.ZKRMStateStore&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.zk-address&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master:2181&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.cluster-id&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hadoop-yarn&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--schelduler&lt;/span&gt;失联等待连接时间 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.app.mapreduce.am.scheduler.connection.wait.interval-ms&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;5000&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;配置rm1 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.address.rm1&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master:8132&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.scheduler.address.rm1&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master:8130&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.webapp.address.rm1&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master:8188&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.resource-tracker.address.rm1&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master:8131&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.admin.address.rm1&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master:8033&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.ha.admin.address.rm1&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-master:23142&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;配置rm2 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.address.rm2&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-slave:8132&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.scheduler.address.rm2&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-slave:8130&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.webapp.address.rm2&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-slave:8188&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.resource-tracker.address.rm2&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-slave:8131&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.admin.address.rm2&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-slave:8033&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.ha.admin.address.rm2&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;hdfs-slave:23142&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.nodemanager.aux-services&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;mapreduce_shuffle&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.nodemanager.aux-services.mapreduce.shuffle.class&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;org.apache.hadoop.mapred.ShuffleHandler&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.nodemanager.local-dirs&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;/data/hadoop/data/yarn/local&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.nodemanager.log-dirs&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;/data/hadoop/log/yarn&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;mapreduce.shuffle.port&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;23080&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;故障处理类 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.client.failover-proxy-provider&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;org.apache.hadoop.yarn.client.ConfiguredRMFailoverProxyProvider&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.ha.automatic-failover.zk-base-path&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;/yarn-leader-election&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;
&amp;lt;/configuration&amp;gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;同步配置文件&quot;&gt;同步配置文件&lt;/h5&gt;
&lt;ul&gt;
  &lt;li&gt;同步到所有节点&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;scp &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; /usr/local/hadoop/etc/hadoop hdfs-slave:/usr/local/hadoop/etc/

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h5 id=&quot;修改-slave的haid&quot;&gt;修改 slave的ha.id&lt;/h5&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-slave hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;yarn-site.xml |grep &lt;span class=&quot;nt&quot;&gt;-a2&lt;/span&gt; ha.id
    &amp;lt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;在hdfs-master上配置rm1,在hdfs-slave上配置rm2,注意：一般都喜欢把配置好的文件远程复制到其它机器上，但这个在YARN的另一个机器上一定要修改 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
    &amp;lt;property&amp;gt;
        &amp;lt;name&amp;gt;yarn.resourcemanager.ha.id&amp;lt;/name&amp;gt;
        &amp;lt;value&amp;gt;rm2&amp;lt;/value&amp;gt;
    &amp;lt;/property&amp;gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;启用hadoop&quot;&gt;启用Hadoop&lt;/h5&gt;

&lt;ul&gt;
  &lt;li&gt;所有节点执行&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./sbin/hadoop-daemon.sh start journalnode
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;master&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./bin/hadoop namenode &lt;span class=&quot;nt&quot;&gt;-format&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./bin/hdfs zkfc &lt;span class=&quot;nt&quot;&gt;-formatZK&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./sbin/start-dfs.sh 
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./sbin/start-yarn.sh
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;jps
16896 Jps
30194 NodeManager
27363 JournalNode
30083 ResourceManager
29925 DFSZKFailoverController
29590 DataNode
29448 NameNode
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;slave&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;查看此时的slave 节点进程:
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-slave hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;jps
28489 NodeManager
32345 Jps
25675 JournalNode
28380 DFSZKFailoverController
28222 DataNode

&lt;span class=&quot;c&quot;&gt;## 同步master节点源数据&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-slave hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./bin/hdfs namenode &lt;span class=&quot;nt&quot;&gt;-bootstrapStandby&lt;/span&gt;
...........
&lt;span class=&quot;o&quot;&gt;=====================================================&lt;/span&gt;
About to bootstrap Standby ID nslave from:
           Nameservice ID: hadoop-node
        Other Namenode ID: nmaster
  Other NN&lt;span class=&quot;s1&quot;&gt;'s HTTP address: http://hdfs-master:50070
  Other NN'&lt;/span&gt;s IPC  address: hdfs-master/192.168.3.27:9000
             Namespace ID: 910041107
            Block pool ID: BP-847688455-192.168.3.27-1516010305437
               Cluster ID: CID-15090545-231e-4ba6-a593-1afc74857e9c
           Layout version: &lt;span class=&quot;nt&quot;&gt;-63&lt;/span&gt;
       isUpgradeFinalized: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;=====================================================&lt;/span&gt;
..... common.Storage: Storage directory /data/hadoop/data/dfs/name has been successfully formatted.

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-slave hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./sbin/hadoop-daemon.sh start namenode

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-slave hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./sbin/yarn-daemon.sh start resourcemanager
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-slave hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;jps
28489 NodeManager
857 Jps
25675 JournalNode
28380 DFSZKFailoverController
32765 NameNode
28222 DataNode
478 ResourceManager


&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;web-ui&quot;&gt;web-ui&lt;/h5&gt;
&lt;ul&gt;
  &lt;li&gt;http://hdfs-master:50070/&lt;/li&gt;
&lt;/ul&gt;

&lt;h5 id=&quot;管理命令&quot;&gt;管理命令&lt;/h5&gt;
&lt;ul&gt;
  &lt;li&gt;状态查看&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./bin/hdfs haadmin &lt;span class=&quot;nt&quot;&gt;-getServiceState&lt;/span&gt; nmaster
active
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./bin/hdfs haadmin &lt;span class=&quot;nt&quot;&gt;-getServiceState&lt;/span&gt; nslave
standby

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;未配置自动切换手动操作&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
这条命令的意思是，nslave将变成standby，nmaster变成active。而且手动状态下需要重启服务
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./bin/hdfs haadmin &lt;span class=&quot;nt&quot;&gt;-failover&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--forcefence&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--forceactive&lt;/span&gt; nmaster nslave

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./bin/hdfs haadmin &lt;span class=&quot;nt&quot;&gt;-transitionToActive&lt;/span&gt; nslave
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;hadoop@hdfs-master hadoop]&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./bin/hdfs haadmin &lt;span class=&quot;nt&quot;&gt;-transitionToStandby&lt;/span&gt; nmaster

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Jevic</name></author><summary type="html"></summary></entry></feed>